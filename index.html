<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSICO MANAGER - Gerenciamento de Pacientes e Relatórios</title>
    <style>
        /* --- Cores e Tipografia (Mantendo o Layout Profissional) --- */
        :root {
            --cor-principal: #3498db; /* Azul */
            --cor-secundaria: #2c3e50; /* Azul Escuro */
            --cor-fundo: #f4f6f9;
            --cor-fundo-card: #ffffff;
            --cor-borda: #dcdfe6;
            --cor-sucesso: #2ecc71; /* Verde */
            --cor-erro: #e74c3c; /* Vermelho */
            --cor-aviso: #f39c12; /* Laranja */
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--cor-fundo);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }

        /* --- Menu Lateral (Sidebar) --- */
        .sidebar {
            width: 200px;
            background-color: var(--cor-secundaria);
            color: white;
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            position: fixed;
            height: 100%;
            z-index: 10;
        }
        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--cor-principal);
            font-size: 1.5em;
        }
        .sidebar a {
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            color: #dcdde1;
            transition: background 0.3s, color 0.3s;
            border-left: 5px solid transparent;
            cursor: pointer;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: #34495e;
            color: white;
            border-left: 5px solid var(--cor-principal);
        }
        .sidebar a::before {
            content: "•";
            margin-right: 10px;
            color: var(--cor-principal);
        }

        /* --- Conteúdo Principal e Views --- */
        .content {
            margin-left: 200px;
            padding: 40px;
            flex-grow: 1;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header h1 {
            margin: 0;
            color: var(--cor-secundaria);
        }
        .card {
            background-color: var(--cor-fundo-card);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        /* --- Elementos de Formulário e Botões --- */
        h2 {
            color: var(--cor-principal);
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h3 {
             color: var(--cor-secundaria);
             margin-top: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--cor-borda);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        button {
            background: var(--cor-principal);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
            margin-top: 10px;
        }
        button:hover {
            background: #2980b9;
        }
        #buscaForm {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        #buscaForm .form-group {
            flex-grow: 1;
            margin-bottom: 0;
        }
        #top-buttons button {
            background: var(--cor-sucesso);
            margin-left: 10px;
        }
        .alert {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
        }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* --- Dados do Paciente e Histórico --- */
        .dados-paciente p {
            background: #ecf0f1;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 4px solid var(--cor-principal);
        }
        .historico {
            background: #fcfcfc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--cor-borda);
            max-height: 250px;
            overflow-y: auto;
        }
        .historico p {
            margin: 8px 0;
            padding-bottom: 8px;
            border-bottom: 1px dashed #cfd8dc;
            font-size: 0.95em;
        }
        
        /* --- Estilo do Relatório --- */
        .relatorio-summary {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-top: 20px;
            margin-bottom: 30px;
        }
        .relatorio-item {
            padding: 15px 30px;
            background: var(--cor-principal);
            color: white;
            border-radius: 8px;
            flex: 1;
            margin: 0 10px;
        }
        .relatorio-item h4 {
            margin: 0 0 5px 0;
            font-size: 1.5em;
        }
        .relatorio-item p {
            margin: 0;
            font-size: 0.9em;
            opacity: 0.8;
        }
        .relatorio-item.total {
             background: var(--cor-sucesso);
        }
        
        /* Oculta os placeholders da Agenda */
        #viewAgenda, #viewRelatoriosPlaceholder { display: none; } 
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>PSICO MANAGER</h2>
        <a id="navClientes" class="active" data-view="clientes">Clientes/Sessões</a>
        <a id="navRelatorios" data-view="relatorios">Relatórios</a>
    </div>

    <div class="content">

        <div class="header">
            <h1 id="mainTitle">Gerenciamento de Clientes e Sessões</h1>
            <div id="top-buttons">
                <button id="btnVerPacientes" style="background: var(--cor-aviso);">Ver Todos os Clientes</button>
            </div>
        </div>

        <div class="card">
            
            <div id="viewClientes" class="view-content">
                
                <form id="buscaForm">
                    <div class="form-group">
                        <label for="buscaCpf">Buscar cliente pelo **CPF** (somente números):</label>
                        <input type="text" id="buscaCpf" required placeholder="Digite o CPF">
                    </div>
                    <button type="submit">Buscar Cliente</button>
                </form>
                
                <p id="statusMensagem" class="alert"></p>

                <div id="alertaCadastro" class="alert-info" style="display:none;">
                    O cliente com o CPF <span id="cpfNaoEncontrado"></span> não foi encontrado. Por favor, preencha o cadastro.
                </div>

                <form id="cadastroForm" style="display:none;" class="card">
                    <h2>Cadastro Rápido de Novo Cliente</h2>
                    <input type="hidden" name="action" value="cadastrarPaciente">
                    
                    <div class="form-group">
                        <label for="cNome">Nome Completo:</label>
                        <input type="text" name="nome" id="cNome" required>
                    </div>
                    <div class="form-group">
                        <label for="cCPF">CPF:</label>
                        <input type="text" name="cpf" id="cCPF" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="cPreco">Preço da Sessão (R$):</label>
                        <input type="number" name="preco" id="cPreco" step="0.01" min="0" value="0.00" required>
                    </div>
                    <div class="form-group" style="display:none;">
                        <label for="cNasc">Data de Nascimento:</label>
                        <input type="date" name="data_nascimento" id="cNasc">
                    </div>
                    <div class="form-group" style="display:none;">
                        <label for="cTratamento">Tratamento/Condição:</label>
                        <input type="text" name="tratamento" id="cTratamento">
                    </div>
                    
                    <button type="submit">Finalizar Cadastro e Registrar Sessão</button>
                </form>


                <div id="dadosPaciente" style="display:none;" class="card">
                    <h2>Informações do Cliente</h2>
                    <div class="dados-paciente">
                        <p><b>Nome:</b> <span id="pNome"></span></p>
                        <p><b>CPF:</b> <span id="pCPF"></span></p>
                        <p><b>Tratamento:</b> <span id="pTratamento"></span></p>
                        <p><b>Preço da Sessão:</b> R$ <span id="pPreco"></span></p>
                        <div class="relatorio-summary">
                            <div class="relatorio-item">
                                <h4><span id="pSessoesTotal">0</span></h4>
                                <p>Total de Sessões</p>
                            </div>
                            <div class="relatorio-item total">
                                <h4>R$ <span id="pTotalGeral">0.00</span></h4>
                                <p>Total Faturado</p>
                            </div>
                        </div>
                    </div>

                    
                    <h3>Registrar Nova Sessão</h3>
                    <form id="novaSessao">
                        <input type="hidden" name="action" value="registrarSessao">
                        <input type="hidden" name="cpf" id="nCPF">
                        
                        <div class="form-group">
                            <label for="data_sessao">Data da Sessão:</label>
                            <input type="date" name="data_sessao" id="data_sessao" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="anotacao">Anotação/Descrição da Consulta:</label>
                            <textarea name="anotacao" id="anotacao" rows="4" placeholder="Detalhes da consulta, evolução do paciente, e observações."></textarea>
                        </div>

                        <button type="submit">Salvar Sessão e Anotação</button>
                    </form>
                    
                    <h3>Histórico de Sessões Anteriores</h3>
                    <div id="pHistorico" class="historico"></div>
                </div>

                <div id="listaPacientesContainer" style="display:none;" class="card">
                    <h2>Lista de Clientes Cadastrados</h2>
                    <ul id="listaPacientes"></ul>
                </div>

            </div> <div id="viewRelatorios" class="view-content" style="display:none;">
                <h2>Relatório Financeiro Geral</h2>
                
                <p id="statusMensagemRelatorio" class="alert"></p>
                
                <div id="relatorioContent">
                    <div class="relatorio-summary">
                        <div class="relatorio-item">
                            <h4><span id="rClientesTotal">...</span></h4>
                            <p>Clientes Cadastrados</p>
                        </div>
                        <div class="relatorio-item">
                            <h4><span id="rSessoesGeral">...</span></h4>
                            <p>Sessões Registradas</p>
                        </div>
                        <div class="relatorio-item total">
                            <h4>R$ <span id="rTotalFaturado">...</span></h4>
                            <p>Faturamento Total</p>
                        </div>
                    </div>
                    
                    <h3>Detalhes por Cliente</h3>
                    <table id="tabelaRelatorio" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #ecf0f1;">
                                <th style="padding: 10px; text-align: left;">Cliente</th>
                                <th style="padding: 10px;">Sessões</th>
                                <th style="padding: 10px;">Preço (R$)</th>
                                <th style="padding: 10px; text-align: right;">Total (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

        </div> </div> <script>
        // SEU LINK FINAL DO GOOGLE APPS SCRIPT
        const scriptURL = "https://script.google.com/macros/s/AKfycbxwiOvj9ffd8Tn2SA0CaATKduzRocduv9Cd6pwdwrVGzDuaScc-2qpTc2_XLF7PkyrX/exec";

        // --- Variáveis Globais e DOM ---
        const navLinks = document.querySelectorAll(".sidebar a");
        const viewContents = document.querySelectorAll(".view-content");
        const mainTitle = document.getElementById("mainTitle");
        const statusMensagem = document.getElementById("statusMensagem");
        const statusMensagemRelatorio = document.getElementById("statusMensagemRelatorio");

        // Formulários e Divs
        const buscaForm = document.getElementById("buscaForm");
        const dadosPacienteDiv = document.getElementById("dadosPaciente");
        const novaSessaoForm = document.getElementById("novaSessao");
        const cadastroForm = document.getElementById("cadastroForm");
        const alertaCadastroDiv = document.getElementById("alertaCadastro");
        const btnVerPacientes = document.getElementById("btnVerPacientes");
        const listaPacientesContainer = document.getElementById("listaPacientesContainer");
        const listaPacientesUl = document.getElementById("listaPacientes");

        // --- FUNÇÕES DE NAVEGAÇÃO E VIEWS ---
        function showView(viewId) {
            viewContents.forEach(view => {
                view.style.display = 'none';
            });
            const viewElement = document.getElementById(viewId);
            viewElement.style.display = 'block';

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.view === viewId.replace('view', '').toLowerCase()) {
                    link.classList.add('active');
                    mainTitle.textContent = link.textContent.split("/")[0].trim();
                }
            });
            
            if (viewId === 'viewClientes') {
                 mainTitle.textContent = 'Gerenciamento de Clientes e Sessões';
                 btnVerPacientes.style.display = 'block';
                 // Limpa campos da busca ao voltar
                 document.getElementById("buscaCpf").value = "";
                 resetForms();
            } else if (viewId === 'viewRelatorios') {
                 mainTitle.textContent = 'Relatórios Financeiros';
                 btnVerPacientes.style.display = 'none';
                 carregarRelatorios(); // Chama a função para carregar dados
            }
        }

        // Adiciona evento de clique aos links de navegação
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showView('view' + link.dataset.view.charAt(0).toUpperCase() + link.dataset.view.slice(1));
            });
        });
        
        // --- FUNÇÕES DE STATUS E UTILS ---

        function showStatus(msg, type, isReport = false) {
            const statusEl = isReport ? statusMensagemRelatorio : statusMensagem;
            statusEl.textContent = msg;
            statusEl.className = `alert alert-${type}`;
            setTimeout(() => {
                statusEl.textContent = "";
                statusEl.className = "alert";
            }, 5000);
        }

        function resetForms() {
            dadosPacienteDiv.style.display = "none";
            cadastroForm.style.display = "none";
            alertaCadastroDiv.style.display = "none";
            listaPacientesContainer.style.display = "none";
            statusMensagem.textContent = "";
            statusMensagem.className = "alert";
        }
        
        // --- BUSCA PRINCIPAL POR CPF (Coração do Fluxo) ---
        buscaForm.addEventListener("submit", async e => {
            e.preventDefault();
            const cpf = document.getElementById("buscaCpf").value.trim().replace(/\D/g, ''); 
            
            resetForms();
            
            if (!cpf) {
                showStatus("Por favor, digite o CPF.", "error");
                return;
            }

            showStatus("Buscando cliente e histórico...", "info");

            try {
                // Nova ação: buscarClienteCompleto (deve retornar dados do cliente + histórico)
                const res = await fetch(`${scriptURL}?action=buscarClienteCompleto&cpf=${encodeURIComponent(cpf)}`);
                const dados = await res.json();

                if (dados.erro === "Paciente não encontrado") {
                    // CPF não encontrado: Exibe formulário de CADASTRO IMEDIATO
                    document.getElementById("cpfNaoEncontrado").textContent = cpf;
                    document.getElementById("cCPF").value = cpf;
                    alertaCadastroDiv.style.display = "block";
                    cadastroForm.style.display = "block";
                    // Define o foco no campo Nome
                    document.getElementById("cNome").focus();
                    showStatus("Cliente não encontrado. Preencha o cadastro RÁPIDO.", "info");
                    return;
                } else if (dados.erro) {
                    showStatus(dados.erro, "error");
                    return;
                }

                // Cliente encontrado: Exibe dados, resumo e formulário de sessão
                const p = dados.paciente;
                const historico = dados.historico || [];
                const totalSessoes = historico.length;
                const preco = parseFloat(p.preco || 0);
                const totalGeral = totalSessoes * preco;
                
                dadosPacienteDiv.style.display = "block";
                document.getElementById("pNome").textContent = p.nome;
                document.getElementById("pCPF").textContent = p.cpf;
                // Os campos de Tratamento/Data Nasc. virão vazios se não preenchidos
                document.getElementById("pTratamento").textContent = p.tratamento || "Não informado";
                document.getElementById("pPreco").textContent = preco.toFixed(2);
                
                // Campos do Relatório na View Clientes
                document.getElementById("pSessoesTotal").textContent = totalSessoes;
                document.getElementById("pTotalGeral").textContent = totalGeral.toFixed(2);
                
                // Prepara formulário de sessão
                document.getElementById("nCPF").value = p.cpf;
                document.getElementById("data_sessao").valueAsDate = new Date(); // Data atual
                document.getElementById("anotacao").value = ""; // Limpa a anotação

                // Prepara Histórico
                const historicoHTML = historico.map(h => 
                    `<p><b>Data: ${h.data_sessao}</b> | Anotação: ${h.anotacao || "(sem anotação)"}</p>`
                ).join("");
                document.getElementById("pHistorico").innerHTML = historicoHTML || "<p>Nenhum histórico de sessões encontrado.</p>";
                showStatus("Cliente carregado. Pronto para registrar nova sessão.", "success");

            } catch (error) {
                showStatus("Erro ao conectar com o servidor para buscar cliente.", "error");
                console.error("Erro na busca:", error);
            }
        });

        // CADASTRAR NOVO PACIENTE
        cadastroForm.addEventListener("submit", async e => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            showStatus("Cadastrando cliente...", "info");

            try {
                // Ação de Cadastro
                const res = await fetch(scriptURL, { method: "POST", body: formData });
                const result = await res.json();
                
                if (result.sucesso) {
                    showStatus("Cliente cadastrado! Carregando dados para registrar 1ª sessão...", "success");
                    // Após cadastrar, dispara a busca para abrir a área de Nova Sessão
                    buscaForm.dispatchEvent(new Event('submit')); 
                } else {
                    showStatus(result.erro || "Erro desconhecido ao cadastrar cliente.", "error");
                }
            } catch (error) {
                showStatus("Falha na comunicação de rede ao cadastrar.", "error");
                console.error("Erro no cadastro:", error);
            }
        });


        // SALVAR NOVA SESSÃO
        novaSessaoForm.addEventListener("submit", async e => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            // Adiciona 'Sim' para 'compareceu' e data de registro
            formData.set('compareceu', 'Sim'); 
            
            showStatus("Registrando sessão...", "info");

            try {
                const res = await fetch(scriptURL, { method: "POST", body: formData });
                const result = await res.json();
                
                if (result.sucesso) {
                    showStatus("Sessão registrada com sucesso! Histórico atualizado.", "success");
                    // Recarrega os dados do paciente para atualizar o histórico e o resumo
                    buscaForm.dispatchEvent(new Event('submit')); 
                } else {
                    showStatus(result.erro || "Erro desconhecido ao registrar sessão.", "error");
                }
            } catch (error) {
                showStatus("Falha na comunicação de rede ao registrar sessão.", "error");
                console.error("Erro no registro:", error);
            }
        });


        // VER TODOS OS PACIENTES
        btnVerPacientes.addEventListener("click", async () => {
            showView('viewClientes'); 
            resetForms();
            
            listaPacientesContainer.style.display = "block";
            listaPacientesUl.innerHTML = "<li>Carregando clientes...</li>";
            showStatus("Carregando lista de clientes...", "info");

            try {
                const res = await fetch(`${scriptURL}?action=listarPacientes`);
                const dados = await res.json();

                if (dados.erro) {
                    showStatus(dados.erro, "error");
                    listaPacientesUl.innerHTML = "";
                    return;
                }

                if (dados.pacientes && dados.pacientes.length > 0) {
                    listaPacientesUl.innerHTML = dados.pacientes.map(p => 
                        `<li data-cpf="${p.cpf}">${p.nome} (CPF: ${p.cpf})</li>`
                    ).join("");
                    showStatus("Lista de clientes carregada. Clique para buscar.", "success");
                } else {
                    listaPacientesUl.innerHTML = "<li>Nenhum cliente cadastrado.</li>";
                    showStatus("Nenhum cliente cadastrado.", "info");
                }
            } catch (error) {
                showStatus("Erro ao carregar lista de clientes.", "error");
                console.error("Erro na lista:", error);
                listaPacientesUl.innerHTML = "";
            }
        });

        // Clicar em um paciente da lista para buscar
        listaPacientesUl.addEventListener("click", e => {
            if (e.target.tagName === 'LI') {
                const cpfPaciente = e.target.dataset.cpf;
                document.getElementById("buscaCpf").value = cpfPaciente;
                listaPacientesContainer.style.display = "none"; // Esconde a lista
                buscaForm.dispatchEvent(new Event('submit')); // Dispara a busca
            }
        });
        
        // --- RELATÓRIOS ---
        async function carregarRelatorios() {
            statusMensagemRelatorio.textContent = ""; // Limpa status
            showStatus("Gerando relatório...", "info", true);
            
            try {
                const res = await fetch(`${scriptURL}?action=gerarRelatorioGeral`);
                const dados = await res.json();

                if (dados.erro) {
                    showStatus(dados.erro, "error", true);
                    return;
                }
                
                const { totalClientes, totalSessoesGeral, faturamentoTotal, detalhesClientes } = dados;

                // 1. Resumo Geral
                document.getElementById("rClientesTotal").textContent = totalClientes;
                document.getElementById("rSessoesGeral").textContent = totalSessoesGeral;
                document.getElementById("rTotalFaturado").textContent = parseFloat(faturamentoTotal).toFixed(2);

                // 2. Tabela de Detalhes
                const tbody = document.querySelector("#tabelaRelatorio tbody");
                tbody.innerHTML = '';
                
                if (detalhesClientes && detalhesClientes.length > 0) {
                    detalhesClientes.forEach(cliente => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${cliente.nome}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">${cliente.numSessoes}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">${parseFloat(cliente.precoSessao).toFixed(2)}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">${parseFloat(cliente.totalFaturado).toFixed(2)}</td>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">Nenhum dado de sessão encontrado.</td></tr>';
                }

                showStatus("Relatório carregado com sucesso.", "success", true);

            } catch (error) {
                showStatus("Erro de rede ao carregar relatório.", "error", true);
                console.error("Erro no relatório:", error);
            }
        }
        
        // Inicia na view Clientes
        showView('viewClientes'); 
    </script>
</body>
</html>
    </script>
</body>
</html>
